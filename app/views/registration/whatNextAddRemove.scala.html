@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@(isCurrentYear: Boolean,
  taxYearRange:TaxYearRange,
  additive: Boolean,
  bikForm:Form[RegistrationList])(implicit request:Request[_],
                                  ac: uk.gov.hmrc.play.frontend.auth.AuthContext ,
                                  context: config.PbikContext, applicationMessages: Messages)

@import uk.gov.hmrc.play.views.html.helpers
@import utils.URIInformation._

    @stringBuilderBenefitsAndExpenses(list:Form[RegistrationList], currentString: String = "") = @{
        var sentenceBuilder = ""
        for(i <- 0 to list("actives").indexes.length -1) {
            (list("actives").indexes.length-1) - i match{
                case 0 => sentenceBuilder = sentenceBuilder + Messages("BenefitInKind.label." + list("actives[" + i + "].uid").value.get)
                case 1 => sentenceBuilder = sentenceBuilder + Messages("BenefitInKind.label." + list("actives[" + i + "].uid").value.get) + " and "
                case _ => sentenceBuilder = sentenceBuilder + Messages("BenefitInKind.label." + list("actives[" + i + "].uid").value.get) + ", "
            }
        }
        sentenceBuilder
    }

@benefitLabel = @{Messages("BenefitInKind.label." + bikForm("actives[0].uid").value.get )}
@singleBik = @{if(bikForm("actives").indexes.size > 1 ) {false}else{true}}
@cyminus1 = @{""+taxYearRange.cyminus1}
@cy = @{""+taxYearRange.cy}
@cyplus1 = @{""+taxYearRange.cyplus1}
@metaTitleAdditive = @{if(singleBik){Messages("whatNext.add.heading.singular")}else {Messages("whatNext.add.heading")}}



@parentTemplate(pageTitle = if(additive) {metaTitleAdditive}else{Messages("whatNext.remove.heading")},
                None, Some(ac.principal.accounts.epaye.get.empRef.toString)) {

    <section id="print-section">
        <div id="printContainer"/>
    </section>

    <section id="what-next-update-benefit">
        <div id="confirmation" class="govuk-box-highlight">
            <h1 id="title" class="bold-large">
                @if(additive) {
                    @if(singleBik){
                        @Messages("whatNext.add.heading.singular")
                    }else {
                        @Messages("whatNext.add.heading")
                    }
                } else {@Messages("whatNext.remove.heading")}
            </h1>
            <p id="confirmation-p">
                @if(!isCurrentYear) {
                    @if(additive) {
                        @if(singleBik){
                            @Messages("whatNext.cy1.add.lede.singular", benefitLabel, cy)
                        }else {
                            @Messages("whatNext.cy1.add.lede", cy)
                        }
                    }else {
                        @Html(Messages("whatNext.remove.lede", benefitLabel, cy, cyplus1, bikForm("actives[0].uid").value.get))}
                }else {
                    @if(singleBik){
                        @Messages("whatNext.cy1.add.lede.singular", benefitLabel, cyminus1)
                    }else {
                        @Messages("whatNext.cy1.add.lede", cyminus1)
                    }
                }
            </p>
        </div>

        @if(additive) {
            @if(!singleBik){
                <h2>@Messages("whatNext.cy1.add.table.header")</h2>
                    @helpers.form(action = controllers.registration.routes.ManageRegistrationController.updateRegisteredBenefitTypes()) {
                    <dl class="govuk-check-your-answers cya-questions-short" id="list-of-confirmation-benefits">

                    @helper.repeat(bikForm("actives"), min=0) { activeField =>
                        <div>
                            <div class="cya-answer">
                                <div class="hidden">
                                    @helper.inputText(activeField("uid"), '_label -> "", 'style -> "display: none" )
                                    @helper.inputText(activeField("pbik_seq"), '_label -> "", 'style -> "display: none" )
                                    @helper.inputText(activeField("active"), '_label -> "", 'style -> "display: none" )
                                </div>
                                <span id='li-@activeField("uid").value.get'> @Messages("BenefitInKind.label." + activeField("uid").value.get )</span>
                            </div>
                        </div>
                        }
                    </dl>
                }
            }

            <h2>
                @Messages("whatNext.subHeading")
            </h2>

            @if(isCurrentYear) {
                <!-- CY content will go here when enabled-->
                <ul id="next-steps">
                    <li>@Html(Messages("whatNext.add.p1", stringBuilderBenefitsAndExpenses(bikForm)))</li>
                    @if(singleBik) {
                        <p>@Html(Messages("whatNext.add.p2.singular"))</p>
                        <p>@Html(Messages("whatNext.add.p3.singular", cyminus1, cy))</p>
                    }else {
                        <p>@Html(Messages("whatNext.add.p2", cyplus1))</p>
                        <p>@Html(Messages("whatNext.add.p3", cyminus1, cy))</p>
                    }
                    <li>@Html(Messages("whatNext.add.p4"))</li>
                </ul>
            }else {
                <ul id="next-steps">
                    <p>@Html(Messages("whatNext.add.p1", stringBuilderBenefitsAndExpenses(bikForm)))</p>
                    @if(singleBik) {
                        <p>@Html(Messages("whatNext.add.p2.singular"))</p>
                        <p>@Html(Messages("whatNext.add.p3.singular", cy, cyplus1)) </p>
                    }else {
                        <p>@Html(Messages("whatNext.add.p2", cyplus1))</p>
                        <p>@Html(Messages("whatNext.add.p3", cy, cyplus1))</p>
                    }

                    <li>@Html(Messages("whatNext.add.p4"))</li>
                </ul>
            }

        } else {

            <h2>
                @Messages("whatNext.subHeading")
            </h2>

            <p class="text">
                @Messages("whatNext.remove.p1") <a data-journey-click='@Messages("whatNext.remove.link.a-z-ga-track-EventCategory"):
                                                @if(additive) {
                                                                    @if(singleBik){
                                                                        @Messages("whatNext.add.heading.singular")
                                                                    }else {
                                                                        @Messages("whatNext.add.heading")
                                                                    }
                                                                } else {@Messages("whatNext.remove.heading")}:
                                                @Messages("whatNext.remove.link.P11D")'

                                              href = "https://www.gov.uk/government/publications/paye-end-of-year-expenses-and-benefits-p11d" target="_blank">@Messages("whatNext.remove.link.P11D")</a>
                @Messages("whatNext.remove.p1-after")
            </p>
        }

        <p class="text">
            <a onclick="gaEventLinkOverview()" href="@routes.HomePageController.onPageLoad" id="link-back">
                @Messages("Service.back.overview.whatNext")
            </a>
        </p>
    </section>
}

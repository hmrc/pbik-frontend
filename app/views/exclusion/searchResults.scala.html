@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@(taxYearRange: TaxYearRange,
  year: String, iabdType: String,
  listOfMatchesForm: Form[(String,EiLPersonList)],
  formType: String, empRef: EmpRef)(implicit request: Request[_],
                    context: config.PbikContext, applicationMessages: Messages)

@import uk.gov.hmrc.play.views.html.helpers
@import utils.URIInformation._


@parentTemplate( pageTitle=Messages("ExclusionSearch.title") + " - " + Messages("Service.title"), Some(taxYearRange), Some(empRef.toString) ) {

    @defining( if(year=="cy"){""+taxYearRange.cyminus1}else{""+taxYearRange.cy} ) { yearvalue =>
        @helpers.form(action = routes.ExclusionListController.withOrWithoutNinoDecision(year, iabdValueURLMapper(iabdType)),
            'onsubmit -> "gaEventLinkSteps()") {
            <input type="hidden" id="button-nino"  name="confirmation" value="@formType">
            <button type="submit" class="link-back" id="link-back-top" data-journey-click="link - click:back:@Messages("ExclusionSearch.title")">

                @Messages("Service.back")
            </button>
        }

        <header class="page-header">
            <h1 id="title" class="h1-heading-margin">
                @Messages("ExclusionSearch.title")
            </h1>
        </header>

        <section id="search-results">

         @if(listOfMatchesForm("individuals").indexes.length > 1) {

                @if(listOfMatchesForm("individualSelection").hasErrors) {
                <div class="error-summary-pbik" role="group" aria-labelledby="error-summary-heading-1" tabindex="-1">

                    <h1 class="heading-medium error-summary-pbik-heading" id="error-summary-heading-1">
                        @Messages("Service.errorSummary.heading")
                    </h1>

                    <ul class="error-summary-pbik-list">

                    @if(listOfMatchesForm.error("individualSelection").get.message.equals("error.required")){
                        <li><a href="#selection">@Messages("error.exclusion.multi.selection")</a></li>
                    }

                    </ul>
                </div>
                }

                <p class="lede-para text">
                    @if(year=="cy"){
                        @Messages("ExclusionSearch.intro.multi", Messages("BenefitInKind.label." + iabdType), ""+taxYearRange.cyminus1, ""+taxYearRange.cy)
                    }else{
                        @Messages("ExclusionSearch.intro.multi", Messages("BenefitInKind.label." + iabdType),""+taxYearRange.cy, ""+taxYearRange.cyplus1)
                    }
               </p>

                @if(listOfMatchesForm("individualSelection").hasErrors) {
                    <div class="form-group error">

                        @if(listOfMatchesForm.error("individualSelection").get.message.equals("error.required")){
                        <span id="selection" class="error-notification">
                            @Messages("error.exclusion.multi.selection").
                        </span>
                        }

                }else {
                    <div>
                }


                  @helpers.form(action = routes.ExclusionListController.updateMultipleExclusions(year, iabdValueURLMapper(iabdType)),
                    'onsubmit -> "gaEventConfirmExcludeMulti()") {

                    <h2>@Messages("ExclusionSearch.caption.multi")</h2>
                    <dl class="govuk-check-your-answers cya-questions-short" id="nonino">
                        <div>
                            <div class="cya-question">&nbsp;</div>
                            <div class="cya-question">@Messages("Service.field.name")</div>
                            <div class="cya-question">@Messages("Service.field.nino")
                                <br>
                                <span class="nino-span">@Html(Messages("Service.nino.lastletter"))</span></div>
                            <div class="cya-question">@Messages("Service.field.worksnumber")</div>
                        </div>


                      @repeatWithIndex(listOfMatchesForm("individuals"), min=1) { (listItem,index) =>

                              <div onclick=selectRadioButtonTable('@listItem("nino").value.get-radio')>

                                <div class="cya-answer input">
                                   @if(listItem("nino").value.get.equals(listOfMatchesForm("individualSelection").value.getOrElse(""))){
                                        <input class="radio-indent" id ='@listItem("nino").value.get-radio' type="radio" name="individualSelection" value='@listItem("nino").value.get' checked>
                                    }else{
                                        <input class="radio-indent" id ='@listItem("nino").value.get-radio' type="radio" name="individualSelection" value='@listItem("nino").value.get'>
                                    }
                                </div>
                                <input type="hidden" id='individuals_@{index}_nino' name='individuals[@index].nino' value='@listItem("nino").value.getOrElse("")' />
                                <input type="hidden" id='individuals_@{index}_firstName' name='individuals[@index].firstName' value='@listItem("firstName").value.get' />
                                @if(listItem("secondName").value.isDefined) { <input type="hidden" id='individuals_@{index}_secondName' name='individuals[@index].secondName' value='@listItem("secondName").value.get' /> }
                                <input type="hidden" id='individuals_@{index}_surname' name='individuals[@index].surname' value='@listItem("surname").value.get' />
                                @if(listItem("worksPayrollNumber").value.isDefined) { <input type="hidden" id='individuals_@{index}_worksPayrollNumber' name='individuals[@index].worksPayrollNumber' value='@listItem("worksPayrollNumber").value.get' /> }
                                @if(listItem("dateOfBirth").value.isDefined) { <input type="hidden" id='individuals_@{index}_dateOfBirth' name='individuals[@index].dateOfBirth' value='@listItem("dateOfBirth").value.get' /> }
                                @if(listItem("gender").value.isDefined) { <input type="hidden" id='individuals_@{index}_gender' name='individuals[@index].gender' value='@listItem("gender").value.get' /> }
                                <input type="hidden" id="individuals_@{index}_perOptLock" name="individuals[@index].perOptLock" value='@listItem("perOptLock").value.get'/>
                                <input type="hidden" name="individuals[@index].status" id="status" value="20"/>
                                <div class="cya-answer" id='table-row-name-@listItem("nino").value.get' >
                                    @listItem("surname").value.get, @listItem("firstName").value.get
                                </div>
                                <div class="cya-answer" id='table-row-nino-@listItem("nino").value.get'>
                                  @listItem("nino").value.get
                                </div>
                                <div class="cya-answer" id='table-row-dob-@listItem("nino").value.get'>
                                  @listItem("worksPayrollNumber").value.getOrElse("")
                                </div>

                             </div>

                      }
                    </dl>
                <div style="clear:both"></div>
                <p class="panel-indent panel-border-wide">
                    @Messages("ExclusionImportant.ExcludeEmployee")
                </p>

                     <input type="submit" class="button" role="button" id="button-confirm" value="@Messages("Service.confirm")">
            }

            <p><a class="button-link" id="multi-exlusion-back" onclick="gaEvent('Click back to exclusion overview','From: Search results')"
                  href="@routes.ExclusionListController.performPageLoad(year, iabdValueURLMapper(iabdType))">
                @Messages("Service.back.excluded")</a></p>

         } else {
           @if(listOfMatchesForm("individuals").indexes.length == 1) {

                 <p class="lede-para text">
                  @if(year=="cy"){
                    @Messages("ExclusionSearch.intro", Messages("BenefitInKind.label." + iabdType), ""+taxYearRange.cyminus1, ""+taxYearRange.cy)
                  }else{
                    @Messages("ExclusionSearch.intro",Messages("BenefitInKind.label." + iabdType), ""+taxYearRange.cy, ""+taxYearRange.cyplus1)
                  }
                 </p>

                    @helpers.form(action = routes.ExclusionListController.updateExclusions(year, iabdValueURLMapper(iabdType)),
                    'onsubmit -> "gaEventConfirmExclude()") {
                     @repeatWithIndex(listOfMatchesForm("individuals"), min=1) { (listItem,index) =>
                         <fieldset class="form-group">

                             <input type="hidden" id='individuals_@{index}_nino' name='individuals[@index].nino' value='@listItem("nino").value.get' />
                             <input type="hidden" id='individuals_@{index}_firstName' name='individuals[@index].firstName' value='@listItem("firstName").value.get' />
                             @if(listItem("secondName").value.isDefined) { <input type="hidden" id='individuals_@{index}_secondName' name='individuals[@index].secondName' value='@listItem("secondName").value.get' /> }
                             <input type="hidden" id='individuals_@{index}_surname' name='individuals[@index].surname' value='@listItem("surname").value.get' />
                             @if(listItem("worksPayrollNumber").value.isDefined) { <input type="hidden" id='individuals_@{index}_worksPayrollNumber' name='individuals[@index].worksPayrollNumber' value='@listItem("worksPayrollNumber").value.get' /> }
                             @if(listItem("dateOfBirth").value.isDefined) { <input type="hidden" id='individuals_@{index}_dateOfBirth' name='individuals[@index].dateOfBirth' value='@listItem("dateOfBirth").value.get' /> }
                             @if(listItem("gender").value.isDefined) { <input type="hidden" id='individuals_@{index}_gender' name='individuals[@index].gender' value='@listItem("gender").value.get' /> }
                             <input type="hidden"  id="individuals_@{index}_perOptLock" name="individuals[@index].perOptLock" value='@listItem("perOptLock").value.get'/>
                             <input type="hidden" name="individuals[@index].status" id="status" value="20"/>
                              <h2>@Messages("ExclusionSearch.caption")</h2>
                              <dl class="govuk-check-your-answers cya-questions-short">
                                <div>
                                  <div class="cya-question">@Messages("Service.field.name")</div>
                                  <div class="cya-answer" id="table-row-name">
                                    @listItem("firstName").value.get
                                    @listItem("surname").value.get
                                  </div>
                                </div>
                                <div>
                                  <div class="cya-question">@Html(Messages("Service.field.nino.2lines"))
                                      <br>
                                      <span class="nino-span">@Html(Messages("Service.nino.lastletter"))</span>
                                  </div>
                                  <div class="cya-answer" id="table-row-nino">@listItem("nino").value.get</div>
                                </div>
                                @if(listItem("gender").value.isDefined) {
                                <div>
                                  <div class="cya-question">@Messages("Service.field.worksnumber")</div>
                                  <div class="cya-answer" id="table-row-dob">@listItem("worksPayrollNumber").value.getOrElse("")</div>
                                </div>
                                }
                              </dl>


                         </fieldset>

                      }

                <div style="clear:both"></div>
                <div class="panel-indent panel-border-wide">
                    <p>@Messages("ExclusionImportant.ExcludeEmployee")</p>
                </div>

                <p>
                    <input type="submit" class="button" role="button" id="button-confirm" value="@Messages("Service.confirm")">
                    <p><a class="button-link" id="link-exlusion-back" onclick="gaEvent('Click back to exclusion overview','From: Search results')"
                          href="@routes.ExclusionListController.performPageLoad(year,iabdValueURLMapper(iabdType))">
                        @Messages("Service.back.excluded")</a></p>
                </p>
                }

           } else {
                @if(listOfMatchesForm("individuals").indexes.length < 1) {

                        @helpers.form(action = routes.ExclusionListController.withOrWithoutNinoDecision(year, iabdValueURLMapper(iabdType))) {
                            <input type="hidden" id="button-nino"  name="confirmation" value="@formType">
                            <p class="text">@Html(Messages("ExclusionSearch.Fail.P", "#"))</p>
                        }
                        <p><a class="button-link" id="link-back" onclick="gaEventLinkOverview()"
                              href="@routes.HomePageController.onPageLoad">@Messages("Service.back")</a></p>

                }
            }

        }
        </section>

        <script>
        function gaEventConfirmExcludeMulti() {
          gaEvent("Exclusion for @yearvalue", "On search results screen multi, @Messages("BenefitInKind.label." + iabdType)");
        }
        function gaEventConfirmExclude() {
          gaEvent("Exclusion for @yearvalue", "Employee excluded, @Messages("BenefitInKind.label." + iabdType)");
        }

        </script>
    }
}


@*
 * Copyright 2024 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.PbikAppConfig

@import views.templatemodels.PageTitle

@this(
        govukLayoutWrapper: GovukLayoutWrapper,
        config:PbikAppConfig,
        govukRadios: GovukRadios,
        formWithCSRF: FormWithCSRF,
        pageTitleHeading: components.PageTitleHeading
)

@(
        taxYearRange: TaxYearRange,
        isCurrentTaxYear: String,
        iabdString: String,
        current: List[EiLPerson],
        form: Form[MandatoryRadioButton]
)(implicit request:AuthenticatedRequest[_], messages: Messages)

@govukLayoutWrapper(PageTitle(messages(s"BenefitInKind.label.${Bik.asNPSTypeValue(iabdString)}"), form.hasErrors)) {

    @defining( if(isCurrentTaxYear=="cy"){ taxYearRange.cyminus1 } else { taxYearRange.cy }){ yearvalue =>

        @if(form.hasErrors){
            <div class="govuk-error-summary" role="alert" aria-labelledby="error-summary-heading" tabindex="-1" data-module="govuk-error-summary">
                <h2 class="govuk-error-summary__title" id="error-summary-heading">@messages("Service.errorSummary.heading")</h2>
                <div class="govuk-error-summary__body">
                    <ul class="govuk-list govuk-error-summary__list">
                        <li>
                            <a href="#confirmation-yes">@messages("ExclusionOverview.error.required")</a>
                        </li>
                    </ul>
                </div>
            </div>
        }

        @pageTitleHeading(messages(s"BenefitInKind.label.${Bik.asNPSTypeValue(iabdString)}"))

        @formWithCSRF(action = routes.ExclusionListController.submitExcludedEmployees(isCurrentTaxYear, iabdString)) {

            @if(current.isEmpty) {
                <p class="govuk-body">@messages("ExclusionOverview.notExcludedEmployee.p1", messages(s"BenefitInKind.label.${Bik.asNPSTypeValue(iabdString)}"), yearvalue.toString())</p>
                <p class="govuk-body">@messages("ExclusionOverview.p1." + request.userType)</p>
            } else {
                <p class="govuk-body">@messages("ExclusionOverview.p1." + request.userType)</p>
                <h2 class="govuk-heading-l">@messages("Overview.empty.benefits.h2", s"${taxYearRange.cy}")</h2>
                <table class="govuk-table">
                    <thead class="govuk-table__head">
                        <tr class="govuk-table__row">
                            <th scope="col" class="govuk-table__header">@messages("Service.field.name")</th>
                            <th scope="col" class="govuk-table__header">@messages("Service.field.nino")</th>
                            <th scope="col" class="govuk-table__header">@messages("Service.field.worksnumber")</th>
                            <th scope="col" class="govuk-table__header">@messages("Service.action")</th>
                        </tr>
                    </thead>
                    @for( (person, index) <- current.zipWithIndex ) {
                        <tr class="govuk-table__row">
                            <td class="govuk-table__cell" id="name-@person.nino">@person.firstForename @person.surname</td>
                            <td class="govuk-table__cell" id="nino-@person.nino">@person.nino</td>
                            <td class="govuk-table__cell" id="wpn-@person.nino">@person.worksPayrollNumber</td>
                            <td class="govuk-table__cell">
                                <a class="govuk-link" id='@person.nino-remove' href="@controllers.routes.ExclusionListController.remove(isCurrentTaxYear, iabdString, person.nino)">
                                    @messages("Service.removeexclusion")<span class="govuk-visually-hidden">@messages("Service.for") @person.firstForename @person.surname @person.nino</span>
                                </a>
                            </td>
                        </tr>
                    }
                </table>

            }

            <p class="govuk-body">@messages("ExclusionOverview.p2." + request.userType)</p>

            @if(current.size < config.maximumExclusions ) {
                <div class="govuk-form-group @if(form.hasErrors){govuk-form-group--error}">
                    @if(form.hasErrors) {
                        <span id="error-list-no-selection" class="govuk-error-message">
                            @messages("ExclusionOverview.error.required")
                        </span>
                    }

                    @govukRadios(Radios(
                        fieldset = Some(Fieldset(
                            legend = Some(Legend(
                                content = Text(messages("ExclusionOverview.h2")),
                                classes = "govuk-fieldset__legend--m",
                                isPageHeading = false
                            ))
                        )),
                        hint = Some(Hint(
                            content = Text(messages("ExclusionOverview.h2.hint", config.maximumExclusions))
                        )),
                        name = "confirmation",
                        items = Seq(
                            RadioItem(
                                content = Text(messages("Service.yes")),
                                value = Some("yes"),
                                id = Some("confirmation-yes")
                            ),
                            RadioItem(
                                content = Text(messages("Service.no")),
                                value = Some("no"),
                                id = Some("confirmation-no")
                            )
                        ),
                        classes = "govuk-radios--inline"
                    ))
                </div>

                <input type="submit" class="govuk-button" role="button" id="button-continue" value="@messages("Service.continue")">

            } else {
                <p class="govuk-body">@messages("ExclusionOverview.excludecount.exceeded")</p>
        }

        }


    }
}

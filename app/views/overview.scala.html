@*
 * Copyright 2017 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.i18n.Messages.Implicits._
@import play.api.Play.current

@(cyAllowed: Boolean,
  taxYearRange:TaxYearRange,
  registeredBenefitsCurrentYear: List[Bik],
  registeredBenefitsNextYear: List[Bik],
  serviceBiksCountCY: Int,
  serviceBiksCountCYP1: Int,
  fromYTA: String)(implicit request:Request[_],
                   ac: uk.gov.hmrc.play.frontend.auth.AuthContext,
                   context: config.PbikContext, applicationMessages: Messages)

@import uk.gov.hmrc.play.views.html.helpers
@import utils.BikListUtils._
@import utils.TaxDateUtils._
@import utils.URIInformation._
@import java.util.Calendar

@import config.PbikAppConfig.biksDecommissioned

@sidebarLinks={
    <div class="sidebar-side-bar">
        @sidebar.helpAndContact()
    </div>
}

@parentTemplate(pageTitle = Messages("Overview.heading"), None, Some(ac.principal.accounts.epaye.get.empRef.toString), true,
    showYTAlink = true, sidebarLinks = Some(sidebarLinks)) {

<script>
    //Starts a new GA session
    ga('send', 'pageview', {'sessionControl': 'end'});
</script>

<h1 id="title">@Messages("Overview.heading")</h1>

<section id="what-to-do">

    @if(dateWithinAnnualCodingRun(Calendar.getInstance.getTime)) {
        <div id="latest-updates-message" class="panel-indent panel-border-wide">
            <span>@Messages("Service.news.banner.message")</span>
        </div>
    }

    <h2 id="heading-cy1">
        @Messages("Overview.next.heading", taxYearRange.cy + "", taxYearRange.cyplus1 + "")</h2>

    @if(!registeredBenefitsNextYear.isEmpty) {
        <p class="text">
            @Messages("Overview.next.lead")
        </p>

        <table role="presentation">
            <caption class="caption-margin-top">@Messages("Overview.table.heading.1")</caption>
            <tbody>
                @for( (n, index) <- sortAlphabeticallyByLabels(registeredBenefitsNextYear).zipWithIndex ) {
                    <tr>
                        <td role="gridcell" id="cy1-@n.iabdType" width="40%">@Messages("BenefitInKind.label." + n.iabdType)</td>
                        <td role="gridcell" width="28%">
                            <a id="cy1-exclude-@n.iabdType" href='@controllers.routes.ExclusionListController.performPageLoad("cyp1", iabdValueURLMapper(n.iabdType))'>
                            @if(n.eilCount == 0) {@Messages("Overview.table.exclude.none.link")} else {@Messages("Overview.table.exclude.link")}
                            @if(n.eilCount > 0) {(@n.eilCount)}
                            <span class="hidden-screen-reader"> for @Messages("BenefitInKind.label." + n.iabdType)</span>
                            </a>
                        </td>
                        <td role="gridcell" width="30%">
                            <a id="cy1-remove-@n.iabdType" href="@controllers.registration.routes.ManageRegistrationController.confirmRemoveNextTaxYearNoForm(iabdValueURLMapper(n.iabdType))">
                            @Messages("Overview.table.remove.link")
                            <span class="hidden-screen-reader"> for @Messages("BenefitInKind.label." + n.iabdType)</span>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }else {
        <p id="no-benefits" class="text">
            @Messages("Overview.next.lead.empty", taxYearRange.cy + "")
        </p>
    }

    @if(registeredBenefitsNextYear.size < (serviceBiksCountCYP1 - biksDecommissioned.size)) {
        <a class="button" role="button" id="add-next" href="@controllers.registration.routes.ManageRegistrationController.nextTaxYearAddOnPageLoad">
            @if(registeredBenefitsNextYear.size > 0) {
                @Messages("Overview.table.add.link.more")
            }else {
                @Messages("Overview.table.add.link")
            }
        </a>
    }
    <div style="clear:both"></div>


    @if(cyAllowed || !registeredBenefitsCurrentYear.isEmpty) {
        <h2>@Messages("Overview.current.heading", taxYearRange.cyminus1 + "", taxYearRange.cy + "")</h2>

        @if(!registeredBenefitsCurrentYear.isEmpty) {
            <p class="text">
                @Messages("Overview.current.lead")
            </p>
        }else {
            <p class="text">
                @Messages("Overview.current.lead.empty", taxYearRange.cyminus1 + "")
            </p>
        }
        @if(!cyAllowed) {

        }
        @if(!registeredBenefitsCurrentYear.isEmpty) {
        <table role="presentation">
            <caption class="caption-margin-top">@Messages("Overview.table.heading.1")</caption>
            <tbody>
                @for( (n, index) <- sortAlphabeticallyByLabels(registeredBenefitsCurrentYear).zipWithIndex ) {
                    <tr>
                        <td role="gridcell" id="cy-@n.iabdType" width="40%">@Messages("BenefitInKind.label." + n.iabdType)</td>
                        <td role="gridcell" width="28%">
                            <a id="cy-exclude-@n.iabdType" href='@controllers.routes.ExclusionListController.performPageLoad("cy", iabdValueURLMapper(n.iabdType))'>
                            @if(n.eilCount == 0) {@Messages("Overview.table.exclude.none.link")} else {@Messages("Overview.table.exclude.link")}
                            @if(n.eilCount > 0) {(@n.eilCount)}
                            <span class="hidden-screen-reader"> for @Messages("BenefitInKind.label." + n.iabdType)</span>
                        </a>
                        </td>
                        <td role="gridcell" width="30%"></td>
                    </tr>
                }
            </tbody>
        </table>
        }

        @if(cyAllowed) {
            @if(registeredBenefitsCurrentYear.size < (serviceBiksCountCY-biksDecommissioned.size)) {
                <a class="button" role="button" id="add-next" href="@controllers.registration.routes.ManageRegistrationController.currentTaxYearOnPageLoad">
                    @if(registeredBenefitsCurrentYear.size > 0) {
                    @Messages("Overview.table.add.link.more")
                    }else {
                    @Messages("Overview.table.add.link")
                    }
                </a>
            }
        }
    }

    <div style="display:none" id="is-service-launched-indicator">@cyAllowed</div>

</section>

}
